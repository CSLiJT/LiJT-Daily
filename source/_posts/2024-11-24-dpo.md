---
title: 直接偏好优化（Direct Preference Optimization）原理
mathjax: true
codeblock:
  enable: true
  show_result: true
date: 2024-11-24 16:24:53
tags: 深度学习 LLM
categories: 学习笔记
---

DPO是一种语言模型（language model）的后训练算法，无需使用RL而使之输出与人类偏好对齐。

<!--more-->

## 算法由来
- DPO是一种用于语言模型（language model, LM）的后训练算法。其目标是使得LM的文本输出能够对齐人类偏好（如表述风格、格式等），而无需使用奖励模型（reward model）或其他强化学习算法。
- **DPO核心思想**：偏好优化问题可以转化为二分类问题。

## 算法基本原理
- DPO不需要训练奖励模型。相反，其需要已经打分标注好的偏好优化数据集。具体而言，偏好优化数据集表示为为$D=\{(x,y_a,y_r,l)|x\in X, y_a\in Y, y_r\in Y\}$，即每条数据由四个项构成。其中$x$为prompt，也就是给LM的输入。$y_a$和$y_r$分别是对于$x$的两种回答。其中$y_a$更为人类所偏好；$y_r$更为人类所不偏好
- DPO的核心公式——Bradley-Terry模型：
$$
P(y_a > y_r|x) = \frac{\zeta(y_a|x)}{\zeta(y_a|x) + \zeta(y_r|x)}
$$
$$
= \frac{e^{r(x,y_a)}}{e^{r(x,y_a)}+e^{r(x,y_r)}} = \frac{1}{1+e{-(r(x,y_a) - r(x,y_r))}}
$$
$$
= \sigma(r(x,y_a) - r(x,y_r))
$$
其中$\zeta(\cdot)$是一个实的、正的、处处可导的函数，可以理解为得分函数，为Bradley-Terry模型所定义。在DPO中，要求$\zeta(y|x)=e^{r(x,y)}$，其中$r(x,y)$表示输出$y$相对于输入$x$的奖励得分。这样做的好处是，目标函数可以转化为易于计算的sigmoid函数，即$\sigma(\cdot)$。

- 在DPO中，$r(x,y)$被规定为，模型在给定输入$x$时的输出为$y$的对数概率，即：
$$
r(x,y) = \frac{1}{\beta}\log p(y|x)
$$
其中$\beta$是温度参数，控制概率分布的平滑程度，辅助梯度下降训练。

## 参考文献
- 维基百科. Bradley-Terry Model. [链接](https://en.wikipedia.org/wiki/Bradley%E2%80%93Terry_model)
- csdn. 【基础知识】DPO(Direct Preference Optimization)的原理以及公式是怎样的？. [链接](https://blog.csdn.net/u014386899/article/details/136633074)

<section class="post-full-comments">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
    <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
    <div id="gitalk-container"></div>
    <script>
        var gitalk = new Gitalk({
            clientID: 'e1bbf465a324641f76ce',
            clientSecret: 'b865ad952a6494eb48283884abbe479d3f89f4a4',
            repo: 'LiJT-Daily-Comments',
            owner: 'CSLiJT',
            admin: ['CSLiJT'], //这里可以填写具有写权限的用户名列表，用来初始化Issues的
            id: decodeURI(window.location.pathname),
            distractionFreeMode: true // Facebook-like distraction free mode
        });
        gitalk.render('gitalk-container');
    </script>
</section>